<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FraudGuard AI - Command Center</title>

    <!-- Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap"
        rel="stylesheet">

    <!-- External Libs -->
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Leaflet Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        :root {
            --bg-dark: #050505;
            --bg-panel: rgba(30, 30, 35, 0.4);
            --border-panel: rgba(255, 255, 255, 0.08);
            --text-main: #e0e0e0;
            --accent-cyan: #00f2ff;
            --accent-blue: #0088ff;
            --danger: #ff2a6d;
            --success: #05ffa1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0a0a0c 0%, #1a1a1f 100%);
            background-attachment: fixed;
            /* Fix background while scrolling */
            color: #fff;
            overflow-x: hidden;
            overflow-y: auto;
            /* Enable vertical scrolling */
            min-height: 100vh;
        }

        /* Leaflet Map Dark Theme Fixes */
        .leaflet-container {
            background: #0a0a0c !important;
            /* Prevent white flash */
        }

        .leaflet-popup-content-wrapper,
        .leaflet-popup-tip {
            background: rgba(20, 20, 25, 0.9) !important;
            backdrop-filter: blur(10px);
            color: #fff !important;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }

        /* Header */
        header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 30px;
            z-index: 1000;
        }

        .brand {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 700;
            color: var(--accent-cyan);
            font-size: 1.2rem;
            letter-spacing: -0.5px;
            display: flex;
            align-items: center;
            gap: 12px;
            text-shadow: 0 0 10px rgba(0, 242, 255, 0.5);
        }

        .brand span {
            color: #fff;
        }

        .status-badge {
            background: rgba(0, 242, 255, 0.1);
            color: var(--accent-cyan);
            padding: 6px 16px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid rgba(0, 242, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 242, 255, 0.1);
        }

        /* Main Layout */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 320px 1fr 350px;
            grid-template-rows: auto 1fr;
            /* Auto height for KPIs, rest for content */
            gap: 20px;
            padding: 20px;
            min-height: calc(100vh - 80px);
        }

        .kpi-grid {
            grid-column: 1 / -1;
            /* Span all columns */
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            height: 120px;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 20px;
            height: 100%;
        }

        .map-section {
            height: 100%;
            min-height: 600px;
        }

        .feed-section {
            height: 100%;
        }

        /* Responsive adjustments */
        @media (max-width: 1400px) {
            .dashboard-grid {
                grid-template-columns: 1fr 1fr;
                grid-template-rows: auto auto auto;
            }

            /* Adjust individual cell positions for smaller screens if needed */
        }

        /* Panels (Glassmorphism) */
        .panel {
            background: var(--bg-panel);
            border-radius: 8px;
            border: 1px solid var(--border-panel);
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            transition: border-color 0.3s;
        }

        .panel:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .panel-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: #888;
            margin-bottom: 20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* KPI Cards */
        .kpi-row {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
        }

        .kpi-card {
            background: linear-gradient(135deg, rgba(30, 30, 35, 0.6) 0%, rgba(20, 20, 25, 0.8) 100%);
            padding: 24px;
            border-radius: 8px;
            border: 1px solid var(--border-panel);
            position: relative;
            overflow: hidden;
        }

        .kpi-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--border-panel);
        }

        .kpi-card:nth-child(1)::before {
            background: var(--text-main);
        }

        .kpi-card:nth-child(2)::before {
            background: var(--danger);
        }

        .kpi-card:nth-child(3)::before {
            background: var(--accent-cyan);
        }

        .kpi-card:nth-child(4)::before {
            background: var(--accent-blue);
        }

        .kpi-value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 2.2rem;
            font-weight: 700;
            color: #fff;
            margin: 8px 0;
            letter-spacing: -1px;
        }

        .kpi-label {
            font-size: 0.75rem;
            color: #777;
            font-weight: 500;
        }

        .kpi-trend {
            font-size: 0.7rem;
            position: absolute;
            top: 24px;
            right: 24px;
            padding: 2px 8px;
            border-radius: 4px;
            background: rgba(255, 255, 255, 0.05);
        }

        /* Map Section - Consolidated */
        .map-section {
            grid-column: 2;
            grid-row: 2;
            background: #0a0a0c !important;
            border-radius: 8px;
            border: 1px solid #333;
            overflow: hidden;
            position: relative !important;
            /* Ensure content doesn't spill out */
        }

        html,
        body {
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            background-color: #0a0a0c !important;
            background: #0a0a0c !important;
            /* Fail-safe dark bg */
        }

        #map {
            position: absolute !important;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100% !important;
            height: 100% !important;
            background-color: #0a0a0c !important;
            /* Ensure map area is dark before tiles load */
            border-radius: 8px;
        }

        /* FORCE BLACK BACKGROUND ON EVERYTHING MAP RELATED */
        #map,
        .map-section,
        .leaflet-container,
        .leaflet-pane,
        .leaflet-map-pane,
        .leaflet-tile-pane,
        .leaflet-layer,
        .leaflet-control-zoom-in,
        .leaflet-control-zoom-out,
        .leaflet-control-attribution {
            background-color: #0a0a0c !important;
            background: #0a0a0c !important;
        }

        /* Hide the white background of the tiles while loading */
        .leaflet-tile {
            background: #0a0a0c !important;
        }

        /* NUCLEAR OPTION: Hide any white gaps in the tile grid */
        .leaflet-tile-container {
            background: #0a0a0c !important;
        }

        /* Removed gradient overlay - was causing visual issues */

        /* Force dark on canvas elements too */
        .leaflet-canvas-container,
        .leaflet-image-layer,
        .leaflet-zoom-animated {
            background: #0a0a0c !important;
        }

        /* Removed invert filter - was making dark tiles appear light */

        /* Activity Feed */
        .feed-section {
            grid-column: 3;
            grid-row: 2;
        }

        .feed-list {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-right: 5px;
        }

        .feed-item {
            background: rgba(255, 255, 255, 0.02);
            padding: 15px;
            border-radius: 6px;
            border-left: 2px solid transparent;
            transition: all 0.2s;
            cursor: default;
        }

        .feed-item:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(5px);
        }

        .feed-item.fraud {
            border-left-color: var(--danger);
            background: linear-gradient(90deg, rgba(255, 42, 109, 0.05) 0%, transparent 100%);
        }

        .feed-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .feed-amount {
            font-family: 'JetBrains Mono';
            font-weight: 700;
            color: #fff;
            font-size: 0.9rem;
        }

        .feed-time {
            color: #555;
            font-size: 0.7rem;
            font-family: 'JetBrains Mono';
        }

        .feed-meta {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 10px;
            font-size: 0.8rem;
            color: #aaa;
        }

        .feed-cat {
            color: #666;
            font-size: 0.75rem;
            text-align: right;
        }

        /* Chart Section */
        .chart-section {
            grid-column: 1;
            grid-row: 2;
        }

        .chart-container {
            flex: 1;
            position: relative;
            width: 100%;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: #333;
            border-radius: 2px;
        }

        /* Alert Overlay */
        .alert-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(255, 42, 109, 0.2) 0%, transparent 70%);
            border: 2px solid var(--danger);
            box-shadow: inset 0 0 100px var(--danger);
            pointer-events: none;
            opacity: 0;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Leaflet Popup Customization */
        .leaflet-popup-content-wrapper {
            background: rgba(10, 10, 12, 0.95);
            color: #fff;
            border: 1px solid var(--danger);
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
            box-shadow: 0 0 20px rgba(255, 42, 109, 0.3);
        }

        .leaflet-popup-tip {
            background: rgba(10, 10, 12, 0.95);
        }

        .leaflet-popup-content b {
            color: var(--danger);
            font-family: 'JetBrains Mono';
        }

        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.6;
            }
        }

        .status-badge {
            animation: pulse 2s infinite;
        }
    </style>
</head>

<body>
    <div class="alert-overlay" id="alertOverlay"></div>

    <header>
        <div class="brand">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5" />
            </svg>
            FRAUD<span>GUARD</span> AI
        </div>
        <div class="status-badge">● LIVE STREAMING</div>
    </header>

    <!-- Main Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Top Row: KPIs (Spanning all columns) -->
        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-head">
                    <span class="kpi-label">TOTAL TRANSACTIONS</span>
                    <span class="status-dot status-live">▲ LIVE</span>
                </div>
                <div class="kpi-value" id="totalCount">0</div>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #ff0055;">
                <div class="kpi-head">
                    <span class="kpi-label">FRAUD INTERCEPTED</span>
                    <span class="status-dot status-alert">⚠️ ALERT</span>
                </div>
                <div class="kpi-value" style="color: #ff0055;" id="fraudCount">0</div>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #00f2ff;">
                <div class="kpi-label">RISK RATIO</div>
                <div class="kpi-value" style="color: var(--accent-cyan);" id="fraudRate">0%</div>
            </div>
            <div class="kpi-card" style="border-left: 4px solid #0066ff;">
                <div class="kpi-label">ENTITIES MONITORED</div>
                <div class="kpi-value" id="customerCount">0</div>
            </div>
        </div>

        <!-- Left Column: Charts -->
        <div class="left-column">
            <!-- 1. Traffic Chart (Reduced Height) -->
            <div class="panel chart-section" style="flex: 0 0 300px;">
                <div class="panel-title">
                    <span>INCOMING TRAFFIC</span>
                    <span style="color: var(--accent-cyan); font-size: 0.7em;">● LIVE TPS</span>
                </div>
                <div class="chart-container" style="height: 240px;">
                    <canvas id="tpsChart"></canvas>
                </div>
            </div>

            <!-- 2. New Dashboard: Fraud by Category -->
            <div class="panel" style="flex: 1;">
                <div class="panel-title">FRAUD BY CATEGORY</div>
                <div style="height: calc(100% - 40px); display: flex; align-items: center; justify-content: center;">
                    <canvas id="categoryChart"></canvas>
                </div>
            </div>

            <!-- 3. New Dashboard: System Health -->
            <div class="panel" style="flex: 0 0 150px;">
                <div class="panel-title">SYSTEM HEALTH <span style="font-size:0.6rem; color:#00f2ff">● LIVE</span></div>
                <div style="padding: 15px; font-family: 'JetBrains Mono', monospace; font-size: 0.8rem; color: #888;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>CPU Load</span>
                        <span id="cpuLoad" style="color:#00f2ff">--</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
                        <span>Memory</span>
                        <span id="memoryUsage" style="color:#00f2ff">--</span>
                    </div>
                    <div style="display:flex; justify-content:space-between;">
                        <span>DB Latency</span>
                        <span id="dbLatency" style="color:#4cd137">--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Center: Map -->
        <div class="panel map-section" style="position: relative;">
            <div class="panel-title"
                style="position: absolute; top: 20px; left: 20px; z-index: 500; background: rgba(0,0,0,0.7); padding: 5px 10px; border-radius: 4px; border: 1px solid #333;">
                LIVE GEOLOCATION
            </div>
            <div id="map"></div>
        </div>

        <!-- Right: Feed -->
        <div class="panel feed-section">
            <div class="panel-title">
                <span>THREAT LOG</span>
                <span id="feedStatus" style="font-size:0.6rem">CONNECTING...</span>
            </div>
            <div class="feed-list" id="feedList">
                <!-- Items injected here -->
            </div>
        </div>
    </div>

    <script>
        const socket = io();

        // --- Map Setup (Leaflet) ---
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            preferCanvas: true,
            minZoom: 3,
            maxZoom: 10
        }).setView([39.8283, -98.5795], 4); // US Center, zoom 4

        // Fit to continental US bounds for better visibility
        map.fitBounds([[24.5, -125], [49.5, -66.5]]); // Continental US

        // Force black background on map container immediately
        document.getElementById('map').style.backgroundColor = "#0a0a0c";

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19,
            opacity: 0.9,
            className: 'dark-tiles'
        }).addTo(map);

        const fraudIcon = L.divIcon({
            className: 'custom-div-icon',
            html: "<div style='background-color:#ff2a6d;width:12px;height:12px;border-radius:50%;box-shadow:0 0 15px rgba(255,42,109,0.8);border:2px solid #fff'></div>",
            iconSize: [12, 12],
            iconAnchor: [6, 6]
        });

        // --- Chart Setup (Chart.js) ---
        Chart.defaults.color = '#666';
        Chart.defaults.font.family = 'JetBrains Mono';

        // 1. TPS Chart
        const ctxTPS = document.getElementById('tpsChart').getContext('2d');
        const gradientTPS = ctxTPS.createLinearGradient(0, 0, 0, 400);
        gradientTPS.addColorStop(0, 'rgba(0, 242, 255, 0.4)');
        gradientTPS.addColorStop(1, 'rgba(0, 242, 255, 0)');

        const tpsChart = new Chart(ctxTPS, {
            type: 'line',
            data: {
                labels: Array(60).fill(''),
                datasets: [{
                    label: 'Fraud Activity',
                    data: Array(60).fill(0), // Start empty, fill with real data
                    borderColor: '#00f2ff',
                    backgroundColor: gradientTPS,
                    borderWidth: 2,
                    tension: 0.3,
                    fill: true,
                    pointRadius: 0,
                    pointHoverRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(10,10,12,0.9)',
                        titleColor: '#888',
                        bodyColor: '#fff',
                        borderColor: '#333',
                        borderWidth: 1,
                        displayColors: false
                    }
                },
                scales: {
                    x: { display: false },
                    y: {
                        display: true,
                        grid: { color: 'rgba(255,255,255,0.05)' },
                        ticks: { color: '#444', font: { family: 'JetBrains Mono' } },
                        suggestedMin: 0, suggestedMax: 20 // Lower max to make small spikes look bigger
                    }
                },
                animation: false
            }
        });

        // 2. Category Pie Chart (starts empty, filled by API)
        const ctxPie = document.getElementById('categoryChart').getContext('2d');
        const pieColors = ['#ff2a6d', '#00f2ff', '#05ffa1', '#ffd700', '#bd00ff', '#ff6b35'];
        const categoryChart = new Chart(ctxPie, {
            type: 'doughnut',
            data: {
                labels: ['Loading...'],
                datasets: [{
                    data: [1],
                    backgroundColor: pieColors,
                    borderWidth: 0,
                    hoverOffset: 4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'right', labels: { boxWidth: 12, font: { size: 11 }, color: '#aaa' } }
                },
                cutout: '65%'
            }
        });

        // Fetch real category data
        function updateCategoryChart() {
            fetch('/api/category_stats')
                .then(res => res.json())
                .then(data => {
                    if (data.labels && data.data) {
                        categoryChart.data.labels = data.labels;
                        categoryChart.data.datasets[0].data = data.data;
                        categoryChart.update();
                    }
                })
                .catch(err => console.warn('Category stats unavailable'));
        }

        // Fetch real system health metrics
        function updateSystemHealth() {
            fetch('/api/system_health')
                .then(res => res.json())
                .then(data => {
                    if (data.cpu_percent !== undefined) {
                        document.getElementById('cpuLoad').innerText = data.cpu_percent + '%';
                        document.getElementById('memoryUsage').innerText = data.memory_gb + 'GB';
                        document.getElementById('dbLatency').innerText = data.latency_ms > 0 ? data.latency_ms + 'ms' : 'ERR';
                        // Color code latency
                        const latEl = document.getElementById('dbLatency');
                        if (data.latency_ms < 50) latEl.style.color = '#4cd137';
                        else if (data.latency_ms < 200) latEl.style.color = '#ffd700';
                        else latEl.style.color = '#ff2a6d';
                    }
                })
                .catch(err => console.warn('System health unavailable'));
        }

        // Initial load + refresh intervals
        updateCategoryChart();
        updateSystemHealth();
        setInterval(updateCategoryChart, 5000);
        setInterval(updateSystemHealth, 3000);

        // --- Data Logic ---
        function updateStats(data) {
            document.getElementById('fraudCount').innerText = data.fraud_count.toLocaleString();
            document.getElementById('totalCount').innerText = (data.fraud_count + data.non_fraud_count).toLocaleString();
            document.getElementById('customerCount').innerText = data.customer_count.toLocaleString();
            document.getElementById('fraudRate').innerText = data.fraud_rate + '%';
        }

        function addMapMarker(lat, long, merchant, amt, category) {
            if (lat && long) {
                const popupContent = `
                    <div style="min-width:150px">
                        <b>⚠️ FRAUD DETECTED</b><br>
                        <div style="margin-top:5px; border-top:1px solid #333; padding-top:5px; font-size:0.85rem">
                            <span style="color:#aaa">Merchant:</span> ${merchant}<br>
                            <span style="color:#aaa">Amount:</span> <span style="color:#fff">$${amt.toFixed(2)}</span><br>
                            <span style="color:#aaa">Category:</span> ${category}
                        </div>
                    </div>
                `;

                L.marker([lat, long], { icon: fraudIcon })
                    .addTo(map)
                    .bindPopup(popupContent);
                //.openPopup(); // Too noisy to open all
            }
        }

        function triggerAlert() {
            const overlay = document.getElementById('alertOverlay');
            overlay.style.opacity = '1';
            setTimeout(() => overlay.style.opacity = '0', 500);
        }

        // --- Socket Events ---
        let isFirstLoad = true;

        socket.on('fraud_alert', (data) => {
            // Update counts
            if (data.count) {
                // Determine TPS
                const lastFraud = parseInt(document.getElementById('fraudCount').innerText.replace(/,/g, '')) || 0;
                const newFraud = data.count;
                const delta = Math.max(0, newFraud - lastFraud);

                // Update Chart
                const chartData = tpsChart.data.datasets[0].data;
                chartData.shift();
                chartData.push(Math.max(delta * 8, Math.random() * 20 + 5)); // Amplify delta for visuals
                tpsChart.update();
            }

            // Update Feed & Map
            if (data.recent && data.recent.length > 0) {
                const list = document.getElementById('feedList');
                if (isFirstLoad) { list.innerHTML = ''; isFirstLoad = false; }

                document.getElementById('feedStatus').innerText = "● RECEIVING DATA";
                document.getElementById('feedStatus').style.color = "#00f2ff";

                data.recent.forEach(f => {
                    // Prevent dupes if possible, but simplest is just prepend
                    // Only add if not already top element (simple dedup)

                    const item = document.createElement('div');
                    item.className = 'feed-item fraud';
                    item.innerHTML = `
                        <div class="feed-header">
                            <span class="feed-amount">$${f.amount.toFixed(2)}</span>
                            <span class="feed-time">${f.time.split(' ')[1] || 'Now'}</span>
                        </div>
                        <div class="feed-meta">
                            <span>${f.merchant.substring(0, 18)}</span>
                            <span class="feed-cat">${f.category}</span>
                        </div>
                    `;
                    list.prepend(item);
                    if (list.children.length > 30) list.lastChild.remove();

                    // Add to Map if coords exist
                    if (f.lat && f.long) {
                        addMapMarker(f.lat, f.long, f.merchant, f.amount, f.category);
                    }
                });

                triggerAlert();
            }

            // Refresh main stats stats
            fetch('/api/stats').then(r => r.json()).then(updateStats);
        });

        // Initial Load
        fetch('/api/stats').then(r => r.json()).then(updateStats);

        // Load initial "Hotspots" (Historical)
        fetch('/api/map_data').then(r => r.json()).then(data => {
            data.forEach(p => {
                addMapMarker(p.lat, p.long, p.merchant, p.amt, "Historical");
            });
        });

        // Poll stats every 5 seconds
        setInterval(() => fetch('/api/stats').then(r => r.json()).then(updateStats), 5000);

        // TPS Chart - track FRAUD DETECTION RATE (updates every 2 seconds for responsiveness)
        let lastFraudCount = 0;
        setInterval(() => {
            fetch('/api/stats').then(r => r.json()).then(data => {
                const currentFraud = data.fraud_count;
                const newFrauds = Math.max(0, currentFraud - lastFraudCount);

                // Amplify signal: each new fraud = 10 units on chart for visibility
                const chartValue = newFrauds > 0 ? newFrauds * 10 : Math.random() * 2;

                const chartData = tpsChart.data.datasets[0].data;
                chartData.shift();
                chartData.push(chartValue);
                tpsChart.update('none');

                lastFraudCount = currentFraud;
            });
        }, 2000);

        // Auto-refresh recent fraud feed every 3 seconds WITHOUT PAGE RELOAD
        let lastFeedCount = 0;
        function refreshFraudFeed() {
            fetch('/api/recent_fraud')
                .then(r => r.json())
                .then(data => {
                    if (data && data.length > 0) {
                        const list = document.getElementById('feedList');
                        if (isFirstLoad) { list.innerHTML = ''; isFirstLoad = false; }

                        document.getElementById('feedStatus').innerText = "● RECEIVING DATA";
                        document.getElementById('feedStatus').style.color = "#00f2ff";

                        // Only trigger alert flash if new fraud detected
                        if (data.length > lastFeedCount) {
                            triggerAlert();
                            lastFeedCount = data.length;
                        }

                        // Clear and repopulate feed
                        list.innerHTML = '';
                        data.slice(0, 30).forEach(f => {
                            const item = document.createElement('div');
                            item.className = 'feed-item fraud';
                            item.style.animation = 'slideIn 0.3s ease-out';
                            item.innerHTML = `
                                <div class="feed-header">
                                    <span class="feed-amount">$${f.amount.toFixed(2)}</span>
                                    <span class="feed-time">${f.time.split(' ')[1] || 'Now'}</span>
                                </div>
                                <div class="feed-meta">
                                    <span>${f.merchant.substring(0, 18)}</span>
                                    <span class="feed-cat">${f.category}</span>
                                </div>
                            `;
                            list.appendChild(item);
                        });
                    }
                });
        }

        // Initial load
        refreshFraudFeed();

        // Refresh feed every 3 seconds
        setInterval(refreshFraudFeed, 3000);

    </script>
</body>

</html>